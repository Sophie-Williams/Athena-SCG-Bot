<html><head><title>AdminMain.java</title></head>
<!-- HTMLized with the Beditor
     *c* Bryan Chadwick, 2003 -->
<style type='text/css'><!--
   .def{ color: #000000; }
   .grade{
      border: solid #FF0000 1px;
      background-color: #FFFF60;
   }
   .gcom{ font-weight: bold; background-color: #FFC0C0; }
   .com{ font-style: italic; color: #880000; }
   .keyw{ font-weight: bold; color: #000088; }
   .num{ color: #00AA00; }
   .func{ color: #BB7733; }
   .str{ color: #CC00AB; }
   .prim{ color: #0000FF; }
--></style>
<body><pre><span class="def">
</span><span class="keyw">package</span><span class="def"> admin;

</span><span class="keyw">import</span><span class="def"> java.util.ArrayList;
</span><span class="keyw">import</span><span class="def"> java.util.Calendar;
</span><span class="keyw">import</span><span class="def"> java.util.Date;
</span><span class="keyw">import</span><span class="def"> java.util.GregorianCalendar;
</span><span class="keyw">import</span><span class="def"> java.util.List;

</span><span class="keyw">import</span><span class="def"> logging.Logger;
</span><span class="keyw">import</span><span class="def"> reg.RegServer;
</span><span class="keyw">import</span><span class="def"> scg.Util;
</span><span class="keyw">import</span><span class="def"> scg.game.Game;
</span><span class="keyw">import</span><span class="def"> scg.game.HistoryFile;
</span><span class="keyw">import</span><span class="def"> scg.game.PlayerProxyI;
</span><span class="keyw">import</span><span class="def"> scg.gen.Config;
</span><span class="keyw">import</span><span class="def"> scg.gen.ParseException;
</span><span class="keyw">import</span><span class="def"> scg.gen.PlayerSpec;
</span><span class="keyw">import</span><span class="def"> scg.gen.PlayersFile;
</span><span class="keyw">import</span><span class="def"> edu.neu.ccs.demeterf.util.CLI;

</span><span class="com">/**  */</span><span class="def">
</span><span class="keyw">public</span><span class="def"> </span><span class="keyw">class</span><span class="def"> AdminMain {

    </span><span class="keyw">private</span><span class="def"> </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">final</span><span class="def"> </span><span class="prim">String</span><span class="def"> HISTORY_FILE_PREFIX = </span><span class="str">"files/history/history"</span><span class="def">;
    </span><span class="keyw">private</span><span class="def"> </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">final</span><span class="def"> </span><span class="prim">String</span><span class="def"> HISTORY_FILE_SUFFIX = </span><span class="str">".txt"</span><span class="def">;
    </span><span class="keyw">private</span><span class="def"> </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">final</span><span class="def"> </span><span class="prim">String</span><span class="def"> CONFIG_FILE = </span><span class="str">"files/config.txt"</span><span class="def">;
    </span><span class="com">/** For testing purposes */</span><span class="def">
    </span><span class="keyw">private</span><span class="def"> </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">final</span><span class="def"> </span><span class="prim">String</span><span class="def"> PLAYERS_FILE = </span><span class="str">"files/players.txt"</span><span class="def">;

    </span><span class="com">/** Options */</span><span class="def">
    </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">final</span><span class="def"> </span><span class="prim">String</span><span class="def"> HELP = </span><span class="str">"--help"</span><span class="def">, NO_REG = </span><span class="str">"--noreg"</span><span class="def">, RELATIVE_TIME = </span><span class="str">"--relative"</span><span class="def">;

    </span><span class="com">/** Print usage information and Quit */</span><span class="def">
    </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">void</span><span class="def"> </span><span class="func">usage</span><span class="def">(</span><span class="prim">String</span><span class="def"> err){
        </span><span class="keyw">if</span><span class="def"> (err.</span><span class="func">length</span><span class="def">() &gt; </span><span class="num">0</span><span class="def">) {
            System.err.</span><span class="func">println</span><span class="def">(</span><span class="str">"\n !! "</span><span class="def"> + err + </span><span class="str">"\n"</span><span class="def">);
        }
        System.err.</span><span class="func">println</span><span class="def">(</span><span class="str">" ** Usage: java AdminMain [Options] &lt;Time&gt; [PlayersFile]\n"</span><span class="def">
                + </span><span class="str">"    Options can be:\n"</span><span class="def">
                + </span><span class="str">"      --help      : Print this message\n"</span><span class="def">
                + </span><span class="str">"      --noreg     : Skip registration, use a preset players file\n"</span><span class="def">
                + </span><span class="str">"      --relative  : Use a '</span><span class="def">relative</span><span class="str">' start time instead of an absolute\n"</span><span class="def">
                + </span><span class="str">"                     start time. Used for running a quick competition.\n\n"</span><span class="def">
                + </span><span class="str">"    Absolute Time (default) is formated as: '</span><span class="def">mm/dd/yyyy hh:mm am|pm</span><span class="str">'.\n"</span><span class="def">
                + </span><span class="str">"    Relative Time is an integer; the number of seconds before starting\n\n"</span><span class="def">
                + </span><span class="str">"    If '</span><span class="def">noreg</span><span class="str">' is used, the location of a players info file can be\n"</span><span class="def">
                + </span><span class="str">"      given... otherwise the default is '</span><span class="def"></span><span class="str">" + PLAYERS_FILE + "</span><span class="def"></span><span class="str">'\n"</span><span class="def">);
        System.</span><span class="func">exit</span><span class="def">(</span><span class="num">1</span><span class="def">);
    }

    </span><span class="com">/** Run the Admin... */</span><span class="def">
    </span><span class="keyw">public</span><span class="def"> </span><span class="keyw">static</span><span class="def"> </span><span class="keyw">void</span><span class="def"> </span><span class="func">main</span><span class="def">(</span><span class="prim">String</span><span class="def">[] argArr) </span><span class="keyw">throws</span><span class="def"> Exception{
        edu.neu.ccs.demeterf.lib.List&lt;</span><span class="prim">String</span><span class="def">&gt; split[] = CLI.</span><span class="func">splitArgs</span><span class="def">(argArr), options = split[CLI.OPTS], args = split[CLI.ARGS];
        </span><span class="keyw">if</span><span class="def"> (options.</span><span class="func">contains</span><span class="def">(HELP)) {
            </span><span class="func">usage</span><span class="def">(</span><span class="str">""</span><span class="def">);
        }
        </span><span class="keyw">if</span><span class="def"> (args.</span><span class="func">length</span><span class="def">() &lt; </span><span class="num">1</span><span class="def">) {
            </span><span class="func">usage</span><span class="def">(</span><span class="str">"Not enough manditory arguments"</span><span class="def">);
        }

        </span><span class="prim">String</span><span class="def"> date = args.</span><span class="func">lookup</span><span class="def">(</span><span class="num">0</span><span class="def">);
        List&lt;PlayerSpec&gt; players;
        Date start;
        Logger logger;
        </span><span class="keyw">try</span><span class="def"> {
            </span><span class="keyw">if</span><span class="def"> (options.</span><span class="func">contains</span><span class="def">(RELATIVE_TIME)) {
                Calendar cal = </span><span class="keyw">new</span><span class="def"> </span><span class="func">GregorianCalendar</span><span class="def">();
                cal.</span><span class="func">setTime</span><span class="def">(Util.</span><span class="func">now</span><span class="def">());
                cal.</span><span class="func">add</span><span class="def">(Calendar.SECOND, </span><span class="prim">Integer</span><span class="def">.</span><span class="func">parseInt</span><span class="def">(date));
                start = cal.</span><span class="func">getTime</span><span class="def">();
            } </span><span class="keyw">else</span><span class="def"> {
                start = Util.</span><span class="func">parseDate</span><span class="def">(date);
            }
            logger = Logger.</span><span class="func">text</span><span class="def">(System.out);
            </span><span class="keyw">if</span><span class="def"> (options.</span><span class="func">contains</span><span class="def">(NO_REG)) {
                logger.</span><span class="func">event</span><span class="def">(</span><span class="str">"Skipping Registration"</span><span class="def">);
                </span><span class="prim">String</span><span class="def"> pfile = args.</span><span class="func">length</span><span class="def">() &gt; </span><span class="num">1</span><span class="def"> ? args.</span><span class="func">lookup</span><span class="def">(</span><span class="num">1</span><span class="def">) : PLAYERS_FILE;
                players = </span><span class="func">loadPlayers</span><span class="def">(pfile);
            } </span><span class="keyw">else</span><span class="def"> {
                logger.</span><span class="func">event</span><span class="def">(</span><span class="str">"Registering"</span><span class="def">);
                players = RegServer.</span><span class="func">create</span><span class="def">(logger).</span><span class="func">runRegistration</span><span class="def">(start).</span><span class="func">toJavaList</span><span class="def">();
            }
            Util.</span><span class="func">waitUntil</span><span class="def">(start);
        } </span><span class="keyw">catch</span><span class="def"> (java.text.ParseException pe) {
            </span><span class="func">usage</span><span class="def">(</span><span class="str">"Error parsing Date"</span><span class="def">);
            </span><span class="keyw">return</span><span class="def">;
        } </span><span class="keyw">catch</span><span class="def"> (Exception e) {
            </span><span class="func">usage</span><span class="def">(</span><span class="str">"Exception while starting up: "</span><span class="def"> + e.</span><span class="func">getMessage</span><span class="def">());
            </span><span class="keyw">return</span><span class="def">;
        }
        Game game = </span><span class="keyw">new</span><span class="def"> </span><span class="func">Game</span><span class="def">(</span><span class="func">loadConfig</span><span class="def">(CONFIG_FILE), </span><span class="func">wrapPlayerSpecs</span><span class="def">(players));
        logger.</span><span class="func">event</span><span class="def">(</span><span class="str">"Opening History file"</span><span class="def">);
        HistoryFile history = </span><span class="keyw">new</span><span class="def"> </span><span class="func">HistoryFile</span><span class="def">(HISTORY_FILE_PREFIX, start, HISTORY_FILE_SUFFIX);
        logger.</span><span class="func">event</span><span class="def">(</span><span class="str">"Competition Started"</span><span class="def">);
        game.</span><span class="func">start</span><span class="def">(history);
        logger.</span><span class="func">event</span><span class="def">(</span><span class="str">"Competition Complete"</span><span class="def">);
    }

    </span><span class="keyw">private</span><span class="def"> </span><span class="keyw">static</span><span class="def"> List&lt;? </span><span class="keyw">extends</span><span class="def"> PlayerProxyI&gt; </span><span class="func">wrapPlayerSpecs</span><span class="def">(List&lt;PlayerSpec&gt; playerSpecs){
        List&lt;RemotePlayerProxy&gt; remoteProxies = </span><span class="keyw">new</span><span class="def"> ArrayList&lt;RemotePlayerProxy&gt;();
        </span><span class="keyw">for</span><span class="def"> (PlayerSpec playerSpec : playerSpecs) {
            remoteProxies.</span><span class="func">add</span><span class="def">(</span><span class="keyw">new</span><span class="def"> </span><span class="func">RemotePlayerProxy</span><span class="def">(playerSpec));
        }
        </span><span class="keyw">return</span><span class="def"> remoteProxies;
    }

    </span><span class="com">/**
     * Load playerSpecs from a file
     */</span><span class="def">
    </span><span class="keyw">public</span><span class="def"> </span><span class="keyw">static</span><span class="def"> List&lt;PlayerSpec&gt; </span><span class="func">loadPlayers</span><span class="def">(</span><span class="prim">String</span><span class="def"> playerFile) </span><span class="keyw">throws</span><span class="def"> ParseException, java.io.IOException{
        </span><span class="keyw">return</span><span class="def"> PlayersFile.</span><span class="func">parse</span><span class="def">(</span><span class="keyw">new</span><span class="def"> java.io.</span><span class="func">FileInputStream</span><span class="def">(playerFile)).</span><span class="func">getPlayerSpecs</span><span class="def">().</span><span class="func">toJavaList</span><span class="def">();
    }

    </span><span class="com">/**
     * Load Config from a file
     */</span><span class="def">
    </span><span class="keyw">public</span><span class="def"> </span><span class="keyw">static</span><span class="def"> Config </span><span class="func">loadConfig</span><span class="def">(</span><span class="prim">String</span><span class="def"> configFile) </span><span class="keyw">throws</span><span class="def"> ParseException, java.io.IOException{
        </span><span class="keyw">return</span><span class="def"> Config.</span><span class="func">parse</span><span class="def">(</span><span class="keyw">new</span><span class="def"> java.io.</span><span class="func">FileInputStream</span><span class="def">(configFile));
    }

}
</span></pre></body></html>